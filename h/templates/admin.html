{% extends "base.html" %}

{% block title %}Admin Dashboard - SchoolLearn{% endblock %}

{% block extra_css %}
<style>
    .admin-shell {
        padding: 18px 0 34px 0;
    }

    .admin-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
    }

    .panel {
        background: #ffffff;
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        padding: 16px;
    }

    .panel h2 {
        margin-bottom: 10px;
        color: #133529;
    }

    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }

    .stat-card {
        background: #f6fbf8;
        border: 1px solid #dceae3;
        border-radius: 10px;
        padding: 12px;
    }

    .stat-title {
        font-size: 0.88rem;
        color: #4a655d;
        font-weight: 700;
    }

    .stat-value {
        margin-top: 4px;
        font-size: 1.3rem;
        font-weight: 800;
        color: #0e7e58;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    th, td {
        text-align: left;
        padding: 10px 8px;
        border-bottom: 1px solid #e7f0eb;
        vertical-align: top;
    }

    th {
        color: #2b4d42;
        font-size: 0.9rem;
    }

    td {
        color: #203032;
        font-size: 0.9rem;
    }

    .row-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .btn-small {
        border: 0;
        border-radius: 999px;
        padding: 7px 12px;
        font-size: 0.8rem;
        font-weight: 700;
        cursor: pointer;
    }

    .btn-danger {
        background: #ce3d3d;
        color: #ffffff;
    }

    .btn-secondary {
        background: #2d4f44;
        color: #ffffff;
    }

    .subject-row {
        display: grid;
        grid-template-columns: 1fr auto auto;
        align-items: center;
        gap: 10px;
        padding: 9px 0;
        border-bottom: 1px solid #e7f0eb;
    }

    .subject-row:last-child {
        border-bottom: 0;
    }

    .status-pill {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.78rem;
        font-weight: 700;
    }

    .status-on {
        background: #ddf6ea;
        color: #126545;
    }

    .status-off {
        background: #fee8e8;
        color: #9f2323;
    }

    .question-tools {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
    }

    .inline-form {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
    }

    .inline-form select,
    .question-form input,
    .question-form textarea,
    .question-form select {
        min-height: 40px;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 0.92rem;
        width: 100%;
    }

    .question-form textarea {
        min-height: 80px;
        resize: vertical;
    }

    .question-form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .question-list {
        border: 1px solid #e7f0eb;
        border-radius: 10px;
        max-height: 420px;
        overflow: auto;
    }

    .question-item {
        padding: 10px;
        border-bottom: 1px solid #e7f0eb;
    }

    .question-item:last-child {
        border-bottom: 0;
    }

    .question-meta {
        color: #5f726b;
        font-size: 0.8rem;
        margin-bottom: 6px;
    }

    .question-text {
        font-weight: 700;
        color: #1f3432;
        margin-bottom: 8px;
    }

    .option-list {
        margin: 0 0 8px 0;
        padding-left: 20px;
        color: #3a4d4c;
    }

    .marks-form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 10px;
    }

    .marks-form-grid input,
    .marks-form-grid textarea {
        min-height: 40px;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 0.92rem;
        width: 100%;
    }

    .marks-form-grid textarea {
        min-height: 70px;
        resize: vertical;
    }

    .chart-wrap {
        position: relative;
        width: 100%;
        min-height: 260px;
    }

    @media (max-width: 768px) {
        .subject-row {
            grid-template-columns: 1fr;
            align-items: start;
        }

        .question-form-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const marksSubjectData = {{ result_analytics.subject_summary|tojson }};
    const marksRecentData = {{ result_analytics.recent_entries|tojson }};

    const subjectChartCtx = document.getElementById('marksSubjectChart');
    if (subjectChartCtx) {
        new Chart(subjectChartCtx, {
            type: 'bar',
            data: {
                labels: marksSubjectData.map(item => item.subject),
                datasets: [{
                    label: 'Average %',
                    data: marksSubjectData.map(item => item.average_percentage),
                    backgroundColor: 'rgba(14, 159, 110, 0.7)',
                    borderColor: 'rgba(14, 159, 110, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });
    }

    const recentChartCtx = document.getElementById('marksRecentChart');
    if (recentChartCtx) {
        const ordered = marksRecentData.slice().reverse();
        new Chart(recentChartCtx, {
            type: 'line',
            data: {
                labels: ordered.map((item, idx) => `${item.student_name} #${idx + 1}`),
                datasets: [{
                    label: 'Recent Uploaded %',
                    data: ordered.map(item => item.percentage),
                    borderColor: 'rgba(20, 95, 70, 1)',
                    backgroundColor: 'rgba(20, 95, 70, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });
    }
</script>
{% endblock %}

{% block content %}
<section class="admin-shell">
    <div class="admin-grid">
        <div class="panel">
            <h2>Quiz Overview</h2>
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-title">Total Questions</div>
                    <div class="stat-value">{{ total_questions }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Total Users</div>
                    <div class="stat-value">{{ managed_users|length }}</div>
                </div>
            </div>
            <div class="stats-row">
                {% for subject, count in quiz_counts.items() %}
                <div class="stat-card">
                    <div class="stat-title">{{ subject }}</div>
                    <div class="stat-value">{{ count }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="panel">
            <h2>Quiz Controls</h2>
            {% for key, name in admin_subjects %}
            <div class="subject-row">
                <div>{{ name }}</div>
                {% if canonical_quiz_status[key] %}
                <span class="status-pill status-on">Enabled</span>
                {% else %}
                <span class="status-pill status-off">Disabled</span>
                {% endif %}
                <form method="post" action="{{ url_for('admin_toggle_quiz', subject=key) }}">
                    <input type="hidden" name="enabled" value="{{ 0 if canonical_quiz_status[key] else 1 }}">
                    <button class="btn-small btn-secondary" type="submit">
                        {{ 'Disable' if canonical_quiz_status[key] else 'Enable' }}
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>

        <div class="panel">
            <h2>Question Management</h2>
            <div class="question-tools">
                <form method="get" action="{{ url_for('admin_dashboard') }}" class="inline-form">
                    <label for="subject" style="font-weight:700; color:#2b4d42;">Subject</label>
                    <select id="subject" name="subject" style="max-width:260px;">
                        {% for key, name in admin_subjects %}
                        <option value="{{ key }}" {% if selected_subject == key %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                    <button class="btn-small btn-secondary" type="submit">Load Questions</button>
                </form>

                <form method="post" action="{{ url_for('admin_add_question') }}" class="question-form">
                    <input type="hidden" name="subject" value="{{ selected_subject }}">
                    <input name="question" placeholder="Question text" required>
                    <div class="question-form-grid">
                        <input name="option_a" placeholder="Option A" required>
                        <input name="option_b" placeholder="Option B" required>
                        <input name="option_c" placeholder="Option C" required>
                        <input name="option_d" placeholder="Option D" required>
                    </div>
                    <div class="question-form-grid">
                        <select name="answer" required>
                            <option value="">Correct Option</option>
                            <option value="0">A</option>
                            <option value="1">B</option>
                            <option value="2">C</option>
                            <option value="3">D</option>
                        </select>
                        <textarea name="explanation" placeholder="Explanation (optional)"></textarea>
                    </div>
                    <button class="btn-small btn-secondary" type="submit">Add Question</button>
                </form>

                <div class="question-list">
                    {% for q in selected_subject_questions %}
                    <div class="question-item">
                        <div class="question-meta">{{ q._source|title }} | {{ q._qid }}</div>
                        <div class="question-text">{{ q.question }}</div>
                        <ol class="option-list" type="A">
                            {% for opt in q.options %}
                            <li>{{ opt }}</li>
                            {% endfor %}
                        </ol>
                        <div class="row-actions">
                            <span class="status-pill status-on">Answer: {{ ['A', 'B', 'C', 'D'][q.answer] }}</span>
                            <form method="post" action="{{ url_for('admin_delete_question') }}">
                                <input type="hidden" name="subject" value="{{ selected_subject }}">
                                <input type="hidden" name="qid" value="{{ q._qid }}">
                                <input type="hidden" name="source" value="{{ q._source }}">
                                <button class="btn-small btn-danger" type="submit">Delete Question</button>
                            </form>
                        </div>
                    </div>
                    {% else %}
                    <div class="question-item">No questions available for this subject.</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>User Management</h2>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in managed_users %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ 'Admin' if user.is_admin else 'Student' }}</td>
                        <td>{{ user.joined_at.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <div class="row-actions">
                                <form method="post" action="{{ url_for('admin_toggle_user_admin', user_id=user.id) }}">
                                    <button class="btn-small btn-secondary" type="submit">
                                        {{ 'Make Student' if user.is_admin else 'Make Admin' }}
                                    </button>
                                </form>
                                <form method="post" action="{{ url_for('admin_delete_user', user_id=user.id) }}">
                                    <button class="btn-small btn-danger" type="submit">Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="panel">
            <h2>Marks Upload</h2>
            <form method="post" action="{{ url_for('admin_upload_marks') }}">
                <div class="marks-form-grid">
                    <input list="student-email-list" name="student_email" placeholder="Student email" required>
                    <datalist id="student-email-list">
                        {% for user in managed_users if not user.is_admin %}
                        <option value="{{ user.email }}">{{ user.username }}</option>
                        {% endfor %}
                    </datalist>
                    <input name="exam_name" placeholder="Exam name" required>
                    <input name="subject" placeholder="Subject (e.g., Mathematics)" required>
                    <input type="number" step="0.1" min="0" name="score" placeholder="Score" required>
                    <input type="number" step="0.1" min="1" name="total" placeholder="Total Marks" required>
                    <input type="date" name="exam_date">
                    <textarea name="remarks" placeholder="Remarks (optional)"></textarea>
                </div>
                <div style="margin-top:10px;">
                    <button class="btn-small btn-secondary" type="submit">Upload Marks</button>
                </div>
            </form>
        </div>

        <div class="panel">
            <h2>Result Dashboard</h2>
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-title">Marks Records</div>
                    <div class="stat-value">{{ result_analytics.total_records }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Students with Records</div>
                    <div class="stat-value">{{ result_analytics.unique_students }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Overall Average</div>
                    <div class="stat-value">{{ result_analytics.overall_average }}%</div>
                </div>
            </div>
            <div class="chart-wrap" style="margin-top:12px;">
                <canvas id="marksSubjectChart"></canvas>
            </div>
            <div class="chart-wrap" style="margin-top:12px;">
                <canvas id="marksRecentChart"></canvas>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Exam</th>
                        <th>Subject</th>
                        <th>Marks</th>
                        <th>Percentage</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in result_analytics.recent_entries %}
                    <tr>
                        <td>{{ item.student_name }}<br><small>{{ item.student_email }}</small></td>
                        <td>{{ item.exam_name }}</td>
                        <td>{{ item.subject }}</td>
                        <td>{{ item.score }}/{{ item.total }}</td>
                        <td>{{ item.percentage }}%</td>
                        <td>{{ item.recorded_at_display }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6">No marks uploaded yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>
{% endblock %}
